name: Deploy to Staging

on:
  push:
    branches:
      - develop
  workflow_dispatch:

concurrency:
  group: deploy-staging-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: staging
    env:
        DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
        DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
        DEPLOY_KEY: ${{ secrets.DEPLOY_KEY }}

    steps:
      - name: Checkout
        if: ${{ env.DEPLOY_HOST != '' && env.DEPLOY_PATH != '' && env.DEPLOY_KEY != '' }}
        uses: actions/checkout@v4

      - name: Prepare SSH key
        if: ${{ env.DEPLOY_HOST != '' && env.DEPLOY_PATH != '' && env.DEPLOY_KEY != '' }}
        run: |
          install -m 600 /dev/null ~/.ssh/id_rsa
          printf '%s' "${DEPLOY_KEY}" > ~/.ssh/id_rsa
          DEPLOY_HOSTNAME=${DEPLOY_HOST#*@}
          ssh-keyscan -H "$DEPLOY_HOSTNAME" >> ~/.ssh/known_hosts

      - name: Sync release to staging
        if: ${{ env.DEPLOY_HOST != '' && env.DEPLOY_PATH != '' && env.DEPLOY_KEY != '' }}
        run: |
          rsync -az --delete \
            --exclude '.git' \
            --exclude 'var/cache' \
            --exclude 'var/coverage' \
            --exclude '.github' \
            ./ "${DEPLOY_HOST}:${DEPLOY_PATH}/"

      - name: Install dependencies on remote host
        if: ${{ env.DEPLOY_HOST != '' && env.DEPLOY_PATH != '' && env.DEPLOY_KEY != '' }}
        run: |
          ssh "${DEPLOY_HOST}" "cd '${DEPLOY_PATH}' && composer install --no-dev --optimize-autoloader --no-interaction"
