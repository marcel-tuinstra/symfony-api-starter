{% extends '@!ApiPlatform/SwaggerUi/index.html.twig' %}

{% block head_javascript %}
    {{ parent() }}

    <script>
        window.addEventListener('load', function () {

            const interval = setInterval(() => {
                const authWrapper = document.querySelector('.auth-wrapper');
                if (!authWrapper) return;

                const loginButton = document.createElement('button');
                loginButton.textContent = 'Get token from Keycloak';
                loginButton.classList.add('btn');

                loginButton.addEventListener('click', async function () {
                    try {
                        const response = await fetch(
                            '{{ keycloak.url }}/realms/{{ keycloak.realm }}/protocol/openid-connect/token',
                            {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                                body: new URLSearchParams({
                                    client_id: '{{ keycloak.client_id }}',
                                    client_secret: '{{ keycloak.client_secret }}',
                                    grant_type: 'client_credentials',
                                }),
                            }
                        );

                        const data = await response.json();
                        if (!response.ok) {
                            alert('Failed to get token: ' + (data.error_description ?? 'Unknown error'));
                            return;
                        }

                        const token = data.access_token;

                        // 1. Open the Swagger Authorization modal
                        const authorizeButton = document.querySelector('.auth-wrapper .authorize');
                        authorizeButton.click();

                        // Wait for modal rendering
                        setTimeout(() => {
                            // 2. Insert token into the first input field
                            const input = document.querySelector('.modal-ux-content input[type="text"]');

                            if (!input) {
                                alert("Token fetched, but modal input not found.");
                                return;
                            }

                            // Set value and notify React of the change
                            const nativeInputValueSetter = Object.getOwnPropertyDescriptor(window.HTMLInputElement.prototype, 'value').set;
                            nativeInputValueSetter.call(input, token);
                            input.dispatchEvent(new Event('input', { bubbles: true }));
                            input.dispatchEvent(new Event('change', { bubbles: true }));

                            // 3. Click the internal "Authorize" button (React-compatible)
                            const modalAuthorize = document.querySelector('.modal-ux-content .btn.modal-btn.auth.authorize.button');

                            if (modalAuthorize) {
                                // Use native click(), which React listens to
                                modalAuthorize.click();
                            } else {
                                alert("Authorize button not found.");
                            }

                            // 4. Close the modal
                            setTimeout(() => {
                                const closeButton = document.querySelector('.modal-ux-header .close');
                                if (closeButton) closeButton.click();
                            }, 500);

                        }, 300);

                    } catch (error) {
                        alert('Error: ' + error.message);
                    }
                });

                authWrapper.insertAdjacentElement('beforebegin', loginButton);
                clearInterval(interval);
            }, 500);

        });
    </script>
{% endblock %}
